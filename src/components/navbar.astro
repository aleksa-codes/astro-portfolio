---
import { cn } from '@/lib/utils';
import ThemeToggle from '@/components/theme-toggle.astro';
import { Icon } from 'astro-icon/components';
import Button from '@/components/ui/button.astro';
import SnowToggle from '@/components/snow-toggle.astro';
import { siteConfig } from '@/config/site.config';

interface NavLink {
  href: string;
  label: string;
  dropdown?: {
    href: string;
    label: string;
  }[];
}

const navigationLinks: NavLink[] = siteConfig.navigation;

const isCurrentPage = (href: string) => {
  let pathname = Astro.url.pathname.replace(import.meta.env.BASE_URL, '');
  if (pathname.at(0) !== '/') pathname = '/' + pathname;
  if (pathname.at(-1) !== '/') pathname += '/';
  return pathname === href || (href !== '/' && pathname.startsWith(href));
};
---

<nav
  id='navbar'
  data-scroll='top'
  class='data-[scroll=scrolled]:border-base-300 data-[scroll=scrolled]:bg-base-100/80 sticky top-0 z-40 w-full pt-4 pb-2 data-[scroll=scrolled]:border-b data-[scroll=scrolled]:shadow data-[scroll=scrolled]:backdrop-blur-sm md:pt-6 md:pb-4'
  aria-label='Main navigation'
>
  <div class='container flex items-center justify-between'>
    <!-- Left section: Logo only -->
    <a class='hover:text-secondary font-bold md:text-2xl' href='/'>
      <span id='typed-logo'></span>
    </a>

    <!-- Right section: Navigation + Theme Toggle + CTA -->
    <div class='flex items-center gap-2'>
      <!-- Desktop Navigation -->
      <div class='hidden items-center gap-2 lg:flex' role='navigation' aria-label='Desktop navigation'>
        {
          navigationLinks.map(({ href, label, dropdown }) => (
            <div class='group relative'>
              {dropdown ? (
                <Button
                  variant='ghost'
                  aria-expanded='false'
                  aria-controls={`desktop-dropdown-${label.toLowerCase().replace(/\s+/g, '-')}`}
                  aria-haspopup='true'
                >
                  {label}
                  <Icon
                    name='lucide:chevron-down'
                    class='size-4 transition-transform duration-300 group-focus-within:rotate-180 group-hover:rotate-180'
                    aria-hidden='true'
                  />
                </Button>
              ) : (
                <Button
                  variant='ghost'
                  href={href}
                  class={cn(isCurrentPage(href) && 'text-primary font-medium')}
                  aria-current={isCurrentPage(href) ? 'page' : null}
                >
                  {label}
                </Button>
              )}
              {dropdown && (
                <div
                  id={`desktop-dropdown-${label.toLowerCase().replace(/\s+/g, '-')}`}
                  class='border-base-300 bg-base-100 invisible absolute top-full left-0 z-50 mt-2 min-w-40 translate-y-2 rounded-md border p-2 opacity-0 shadow-md transition-all duration-300 group-focus-within:visible group-focus-within:translate-y-0 group-focus-within:opacity-100 group-hover:visible group-hover:translate-y-0 group-hover:opacity-100'
                  role='menu'
                  aria-orientation='vertical'
                  aria-labelledby={`dropdown-${label.toLowerCase().replace(/\s+/g, '-')}-button`}
                >
                  {dropdown.map((item) => (
                    <a
                      href={item.href}
                      class={cn(
                        'text-base-content/80 hover:bg-base-200 hover:text-base-content focus:bg-base-200 focus:text-base-content block rounded-md px-4 py-2 text-sm transition-colors focus:outline-none',
                        isCurrentPage(item.href) && 'text-primary font-medium',
                      )}
                      role='menuitem'
                      aria-current={isCurrentPage(item.href) ? 'page' : null}
                      tabindex='0'
                    >
                      {item.label}
                    </a>
                  ))}
                </div>
              )}
            </div>
          ))
        }
      </div>

      <!-- Action Buttons -->
      <div class='hidden items-center gap-2 lg:flex'>
        <Button
          variant='ghost'
          size='icon'
          aria-label='GitHub Profile'
          href='https://github.com/aleksa-codes'
          target='_blank'
          rel='noopener noreferrer'
        >
          <Icon name='lucide:github' class='size-5' />
        </Button>
        <Button
          variant='ghost'
          size='icon'
          aria-label='Resume'
          href='https://aleksa-codes.github.io/resume/'
          target='_blank'
          rel='noopener noreferrer'
        >
          <Icon name='lucide:file-badge' class='size-5' />
        </Button>
        <Button
          variant='ghost'
          size='icon'
          aria-label='RSS Feed'
          href='/rss.xml'
          target='_blank'
          rel='noopener noreferrer'
        >
          <Icon name='lucide:rss' class='size-5' />
        </Button>
        <SnowToggle />
        <ThemeToggle />
        <Button href='/contact' variant='secondary' class='px-8'>Contact</Button>
      </div>

      <!-- Mobile Menu Trigger -->
      <Button
        id='mobile-menu-button'
        variant='ghost'
        size='icon'
        class='text-base-content hover:bg-base-200 lg:hidden'
        aria-label='Toggle menu'
        aria-expanded='false'
        aria-controls='mobile-menu'
      >
        <Icon name='lucide:menu' class='size-5' />
      </Button>
    </div>
  </div>
</nav>

<!-- Mobile Menu Panel -->
<div
  id='mobile-menu'
  data-state='closed'
  class='fixed inset-0 z-50 h-screen data-[state=closed]:pointer-events-none lg:hidden'
  role='dialog'
  aria-modal='true'
  aria-label='Mobile navigation menu'
>
  <!-- Backdrop overlay -->
  <div
    id='mobile-menu-backdrop'
    class='bg-neutral/80 fixed inset-0 cursor-pointer transition-opacity duration-300 data-[state=closed]:pointer-events-none data-[state=closed]:opacity-0'
    data-state='closed'
    aria-hidden='true'
  >
  </div>
  <!-- Mobile navigation panel -->
  <div
    id='mobile-menu-panel'
    data-state='closed'
    class='bg-base-100 fixed top-0 right-0 z-50 flex h-full w-72 flex-col px-6 py-4 shadow-lg transition-transform duration-300 data-[state=closed]:translate-x-full data-[state=open]:translate-x-0'
    role='navigation'
    aria-label='Mobile navigation'
  >
    <!-- Mobile menu header -->
    <div class='flex items-center justify-between'>
      <div class='flex items-center gap-2'>
        <Button
          variant='ghost'
          size='icon'
          aria-label='GitHub Profile'
          href='https://github.com/aleksa-codes'
          target='_blank'
          rel='noopener noreferrer'
        >
          <Icon name='lucide:github' class='size-5' />
        </Button>
        <Button
          variant='ghost'
          size='icon'
          aria-label='Resume'
          href='https://aleksa-codes.github.io/resume/'
          target='_blank'
          rel='noopener noreferrer'
        >
          <Icon name='lucide:file-badge' class='size-5' />
        </Button>
        <Button
          variant='ghost'
          size='icon'
          aria-label='RSS Feed'
          href='/rss.xml'
          target='_blank'
          rel='noopener noreferrer'
        >
          <Icon name='lucide:rss' class='size-5' />
        </Button>
      </div>
      <Button id='mobile-menu-close' variant='ghost' size='icon' aria-label='Close menu'>
        <Icon name='lucide:x' class='size-5' aria-hidden='true' />
      </Button>
    </div>
    <hr class='bg-base-300 my-4' role='separator' />
    <!-- Mobile navigation links -->
    <div class='flex flex-col gap-4'>
      <div class='overflow-x-hidden overflow-y-auto'>
        {
          navigationLinks.map(({ href, label, dropdown }) => (
            <div class='space-y-2'>
              {dropdown ? (
                <button
                  class='group hover:text-primary focus-visible:ring-primary flex w-full items-center justify-between rounded-md py-2 focus:outline-none focus-visible:ring-2'
                  data-nav-trigger
                  data-state='closed'
                  aria-expanded='false'
                  aria-controls={`dropdown-${label.toLowerCase().replace(/\s+/g, '-')}`}
                  aria-haspopup='true'
                  id={`dropdown-${label.toLowerCase().replace(/\s+/g, '-')}-button`}
                >
                  <span>{label}</span>
                  <Icon
                    name='lucide:chevron-down'
                    class='size-4 transition-transform duration-300 group-data-[state=open]:rotate-180'
                    data-nav-icon
                    aria-hidden='true'
                  />
                </button>
              ) : (
                <a
                  href={href}
                  class={cn('block py-2', isCurrentPage(href) ? 'text-primary font-medium' : 'hover:text-primary')}
                  aria-current={isCurrentPage(href) ? 'page' : null}
                >
                  {label}
                </a>
              )}
              {dropdown && (
                <div
                  id={`dropdown-${label.toLowerCase().replace(/\s+/g, '-')}`}
                  class='space-y-2 pl-4 data-[state=closed]:hidden data-[state=open]:block'
                  data-nav-content
                  data-state='closed'
                  role='menu'
                  aria-orientation='vertical'
                  aria-labelledby={`dropdown-${label.toLowerCase().replace(/\s+/g, '-')}-button`}
                >
                  {dropdown.map((item) => (
                    <a
                      href={item.href}
                      class={cn(
                        'hover:text-primary text-base-content/80 block py-2 text-sm transition-colors focus:outline-none',
                        isCurrentPage(item.href) && 'text-primary font-medium',
                      )}
                      role='menuitem'
                      aria-current={isCurrentPage(item.href) ? 'page' : null}
                    >
                      {item.label}
                    </a>
                  ))}
                </div>
              )}
            </div>
          ))
        }
      </div>
      <!-- Mobile CTA Button -->
      <Button href='/contact' variant='secondary' class='w-full'>Contact</Button>
    </div>
  </div>
</div>

<script>
  // document.addEventListener('astro:page-load', () => {
  // Type definitions
  type State = 'open' | 'closed';

  // DOM Elements
  const navbar = document.getElementById('navbar');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileMenuButton = document.getElementById('mobile-menu-button');
  const mobileMenuClose = document.getElementById('mobile-menu-close');
  const mobileMenuBackdrop = document.getElementById('mobile-menu-backdrop');
  const mobileMenuPanel = document.getElementById('mobile-menu-panel');
  const navTriggers = document.querySelectorAll('[data-nav-trigger]');

  // Navbar scroll behavior
  function updateNavbarScroll() {
    navbar?.setAttribute('data-scroll', window.scrollY > 0 ? 'scrolled' : 'top');
  }

  // State management
  function toggleMenu(isOpen: boolean) {
    const state: State = isOpen ? 'open' : 'closed';
    [mobileMenu, mobileMenuBackdrop, mobileMenuPanel].forEach((el) => el?.setAttribute('data-state', state));
    mobileMenuButton?.setAttribute('aria-expanded', String(isOpen));
  }

  function toggleDropdown(trigger: HTMLElement, isExpanded: boolean) {
    const state: State = isExpanded ? 'open' : 'closed';
    trigger.setAttribute('aria-expanded', String(isExpanded));
    trigger.setAttribute('data-state', state);

    const content = document.getElementById(trigger.getAttribute('aria-controls') || '');
    content?.setAttribute('data-state', state);
  }

  // Event Listeners

  window.addEventListener('scroll', updateNavbarScroll);
  mobileMenuButton?.addEventListener('click', () => toggleMenu(true));
  mobileMenuClose?.addEventListener('click', () => toggleMenu(false));
  mobileMenuBackdrop?.addEventListener('click', () => toggleMenu(false));
  document.addEventListener('keydown', (e) => e.key === 'Escape' && toggleMenu(false));

  navTriggers.forEach((trigger) => {
    if (trigger instanceof HTMLElement) {
      trigger.addEventListener('click', () => {
        const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
        toggleDropdown(trigger, !isExpanded);
      });
    }
  });
  // });
</script>

<script>
  import Typewriter from 'typewriter-effect/dist/core';
  document.addEventListener('DOMContentLoaded', () => {
    const tw = new Typewriter(document.querySelector('#typed-logo'), {
      loop: false,
      autoStart: true,
    });
    tw.typeString('aleksa.codes').start();
  });
</script>
