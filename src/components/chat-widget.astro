---
import { Icon } from 'astro-icon/components';
import Button from '@/components/ui/button.astro';
import { Image } from 'astro:assets';

const images = import.meta.glob<{ default: ImageMetadata }>('@/assets/chat-avatars/*.jpg');

const loadedImages = await Promise.all(
  Object.values(images).map(async (image) => {
    const { default: src } = await image();
    return src;
  }),
);
---

<script>
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      const chatPanel = document.querySelector('#chat-panel');
      const chatToggle = document.querySelector('#chat-toggle');
      const messageBubble = document.querySelector('#message-bubble');

      // Handle click outside
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const isClickInsidePanel = target.closest('#chat-panel');
        const isClickOnToggle = target.closest('#chat-toggle');

        if (chatPanel && !chatPanel.classList.contains('hidden') && !isClickInsidePanel && !isClickOnToggle) {
          chatPanel.classList.add('hidden');
        }
      });

      // Chat toggle functionality (modified to hide message bubble)
      chatToggle?.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent the document click handler from firing
        chatPanel?.classList.toggle('hidden');
        // Immediately hide message bubble when opening chat
        if (!chatPanel?.classList.contains('hidden')) {
          messageBubble?.classList.add('opacity-0', '-translate-y-2');
          setTimeout(() => {
            messageBubble?.classList.add('hidden');
          }, 300);
        }
      });

      // Message bubble auto-hide (keep this for automatic hiding if panel isn't opened)
      setTimeout(() => {
        if (!messageBubble?.classList.contains('hidden')) {
          messageBubble?.classList.add('opacity-0', '-translate-y-2');
          setTimeout(() => {
            messageBubble?.classList.add('hidden');
          }, 300); // Match transition duration
        }
      }, 5000); // Hide after 5 seconds

      // Handle form submission
      const form = document.querySelector('#chat-form') as HTMLFormElement;
      const formContent = document.querySelector('#form-content');
      const successMessage = document.querySelector('#success-message');

      form?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target as HTMLFormElement);

        try {
          const response = await fetch('/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: new URLSearchParams(formData as any).toString(),
          });

          if (response.ok) {
            formContent?.classList.add('hidden');
            successMessage?.classList.remove('hidden');

            // Reset and hide after 5 seconds
            setTimeout(() => {
              form.reset();
              formContent?.classList.remove('hidden');
              successMessage?.classList.add('hidden');
              document.querySelector('#chat-panel')?.classList.add('hidden');
            }, 5000);
          }
        } catch (error) {
          console.error('Error:', error);
        }
      });
    });
  }
</script>

<div>
  <!-- Message Bubble -->
  <div
    id='message-bubble'
    class='fixed bottom-24 right-4 z-50 flex w-64 animate-bounce-in items-start gap-3 transition-all duration-300'
  >
    <div class='relative w-full rounded-2xl bg-background p-4 shadow-lg dark:bg-muted'>
      <!-- Chat bubble tip -->
      <div class='absolute -bottom-2 right-6 size-4 rotate-45 bg-background dark:bg-muted'></div>

      <div class='flex gap-3'>
        <div class='size-10 overflow-hidden rounded-full bg-primary/10'>
          <Image
            src={loadedImages[Math.floor(Math.random() * loadedImages.length)]}
            alt='Support Avatar'
            width={256}
            height={256}
            format={'webp'}
            class='size-full object-cover'
          />
        </div>
        <div class='flex-1'>
          <p class='font-medium text-foreground'>Hi there! ðŸ‘‹</p>
          <p class='text-sm text-muted-foreground'>Need help? Chat with us!</p>
        </div>
      </div>
    </div>
  </div>

  <Button
    id='chat-toggle'
    variant='default'
    size='icon'
    aria-label='Open chat'
    class='fixed bottom-5 right-5 z-50 size-12 rounded-full shadow-lg transition-all hover:scale-105'
  >
    <Icon name='lucide:message-circle' class='!size-6' />
  </Button>

  <div
    id='chat-panel'
    class='fixed bottom-24 right-4 z-50 hidden w-80 rounded-2xl bg-background p-4 shadow-lg dark:bg-muted'
  >
    <div class='relative'>
      <!-- Chat panel tip -->
      <div class='absolute -bottom-6 right-2 size-4 rotate-45 bg-background dark:bg-muted'></div>

      <!-- Success Message -->
      <div id='success-message' class='hidden space-y-4 text-center'>
        <div class='mx-auto flex size-12 items-center justify-center rounded-full bg-primary/10'>
          <Icon name='lucide:check' class='size-6 text-primary' />
        </div>
        <div class='space-y-2'>
          <h3 class='text-xl font-semibold text-foreground'>Thank you!</h3>
          <p class='text-sm text-muted-foreground'>We'll get back to you as soon as possible.</p>
        </div>
      </div>

      <!-- Form Content -->
      <div id='form-content'>
        <div class='mb-4 space-y-2'>
          <p class='flex items-center gap-2 text-sm font-semibold uppercase tracking-widest text-primary'>
            <Icon name='lucide:messages-square' class='size-5' />
            Chat with us
          </p>
          <p class='text-sm text-muted-foreground'>Send us a message and we'll get back to you soon.</p>
        </div>

        <form
          id='chat-form'
          data-netlify='true'
          netlify-honeypot='bot-field'
          name='chat-widget'
          method='POST'
          class='space-y-4'
        >
          <p class='hidden'>
            <label>Don't fill this out if you're human: <input name='bot-field' /></label>
          </p>
          <input type='hidden' name='form-name' value='chat-widget' />
          <input
            type='hidden'
            name='subject'
            value='%{siteName}: New Inquiry from %{formName} form (id: %{submissionId})'
          />

          <div>
            <label class='block'>
              <span class='flex items-center gap-2 text-sm font-medium text-foreground'>
                <Icon name='lucide:user' class='size-4 text-primary' />
                Name
              </span>
              <input
                type='text'
                name='name'
                class='mt-2 block w-full rounded-md border border-input bg-background px-4 py-2 text-foreground ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring'
              />
            </label>
          </div>

          <div>
            <label class='block'>
              <span class='flex items-center gap-2 text-sm font-medium text-foreground'>
                <Icon name='lucide:mail' class='size-4 text-primary' />
                Email
              </span>
              <input
                type='email'
                name='email'
                required
                class='mt-2 block w-full rounded-md border border-input bg-background px-4 py-2 text-foreground ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring'
              />
            </label>
          </div>

          <div>
            <label class='block'>
              <span class='flex items-center gap-2 text-sm font-medium text-foreground'>
                <Icon name='lucide:message-circle' class='size-4 text-primary' />
                Message
              </span>
              <textarea
                name='message'
                rows='3'
                required
                class='mt-2 block w-full rounded-md border border-input bg-background px-4 py-2 text-foreground ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring'
              ></textarea>
            </label>
          </div>

          <Button type='submit' variant='default' class='w-full'>
            <Icon name='lucide:send' class='size-4' />
            Send Message
          </Button>
        </form>
      </div>
    </div>
  </div>
</div>
